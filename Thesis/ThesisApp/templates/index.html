{% extends "base.html" %}

{% block title %}
    <title>หน้าแรก</title>
{% endblock %}

{% block Home %}
    <a class="nav-link active" aria-current="page" href="/">Home</a>
{% endblock %}

{% block content %}

<script>
  function speak(text, personId, repeatCount) {
      if ('speechSynthesis' in window) {
          var utterance = new SpeechSynthesisUtterance(text);
          utterance.voiceURI = 'native';
          utterance.lang = 'th-TH';
          speechSynthesis.speak(utterance);
          utterance.onend = function() {
              // เมื่อการเล่นเสียงสิ้นสุดลง จะส่งคำร้องขอ AJAX เพื่ออัปเดตสถานะเป็น "Called"
              var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
              var xhr = new XMLHttpRequest();
              xhr.open('POST', '/' + personId + '/', true);
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.setRequestHeader('X-CSRFToken', csrfToken);
              xhr.onreadystatechange = function() {
                  if (xhr.readyState === 4 && xhr.status === 200) {
                      console.log('Status updated successfully.');
                      if (repeatCount === 3) {
                          // เมื่อมีการเล่นเสียงครบ 3 ครั้งและอัปเดตสถานะเรียบร้อยแล้ว จะเปลี่ยนเส้นทาง (redirect) ไปยัง URL ที่กำหนด
                          window.location.href = '/';
                      }
                  }
              };
              xhr.send(JSON.stringify({ status: 'Called' }));
          };
      } else {
          console.log('Web Speech API is not supported.');
      }
  }
  
  function playSpeechAutomatically() {
      // ดึงข้อมูลของผู้ปกครองจากตัวแปร Datatext
      var Datatext = '{{ all_person.children_name }}';
      // สร้างข้อความที่ต้องการพูดโดยรวมกับคำว่า "ผู้ปกครองมารับแล้ว"
      var text = Datatext + 'ผู้ปกครองมารับแล้ว';
      // กำหนดจำนวนครั้งในการเล่นเสียง
      var repeatCount = 3;
      if (Datatext !== '') {
          // วนลูปเพื่อเล่นเสียงตามจำนวนที่กำหนด
          for (var i = 0; i < repeatCount; i++) {
              // ตั้งเวลาในการเล่นเสียงในลำดับที่และกำหนดจำนวนครั้งที่ต้องการให้เล่น
              setTimeout(speak.bind(null, text, '{{ all_person.id }}', i + 1), i * 1000);
          }
      }
  }
  
  playSpeechAutomatically();
  
  </script>


<div class="Show">
  <div class="row">
    <!-- ส่วนซ้าย -->
    <div class=" card col-5 pt-3">
      <img src="https://hips.hearstapps.com/hmg-prod/images/rick-and-morty-image-1662104014.jpg?crop=0.316xw:0.562xh;0.352xw,0.168xh&resize=980:*" class="card-img-top" alt="...">
      <div class="card-body">
        <h1>{{ all_person.Parent_name }}</h1>
      </div>
    </div>
    <!-- ส่วนขวา -->
    <div class="card col-5 pt-3">
      <img src="https://pbs.twimg.com/profile_images/1243449047710609409/yjZxgR40_400x400.jpg" class="card-img-top" alt="...">
      <div class="card-body">
        <h1>{{ all_person.children_name }}</h1>
      </div>
    </div>
  </div>
  
  <div class="row mt-3">
    <!-- ส่วนล่าง -->
    <div class="card col-12">
      <h3>กรุณากรอกหมายเลขผู้ปกครองของท่าน</h3>
        <form method="POST" action="" class="input-group mb-3">
          {% csrf_token %}
          <input type="text" name="search_keyword" class="form-control">
          <input type="submit" class="btn btn-success" value="Search" >
        </form>
    </div>
  </div>
</div>


<style>
  .input-group {
    align-self: center;
    width: 60%;
  }
</style>
{% endblock %}